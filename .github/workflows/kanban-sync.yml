name: Kanban Board Sync

on:
  workflow_run:
    workflows: ["Agile/TDD Pipeline"]
    types:
      - completed

jobs:
  update-kanban:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion != 'cancelled' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Update Kanban board based on pipeline results
      run: |
        echo "Pipeline run conclusion: ${{ github.event.workflow_run.conclusion }}"

        # The kanban board should already be updated by the pipeline itself
        # This workflow serves as a notification/verification step

        python3 .agents/agile/kanban_manager.py show

    - name: Create summary
      run: |
        echo "## Kanban Board Updated" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Pipeline: ${{ github.event.workflow_run.name }}" >> $GITHUB_STEP_SUMMARY
        echo "Status: ${{ github.event.workflow_run.conclusion }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Show current board status
        python3 -c "
        import json
        with open('.agents/agile/kanban_board.json', 'r') as f:
            board = json.load(f)
            done_cards = [c for c in board.get('cards', {}).values() if c.get('column') == 'done']
            print(f'âœ… Cards completed: {len(done_cards)}')
        " >> $GITHUB_STEP_SUMMARY

    - name: Commit updated Kanban board
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add .agents/agile/kanban_board.json
        git diff --staged --quiet || git commit -m "Auto-update Kanban board after pipeline run

        Pipeline: ${{ github.event.workflow_run.name }}
        Status: ${{ github.event.workflow_run.conclusion }}

        ðŸ¤– Automated update by GitHub Actions"

    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}
